<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>GPS Zones – Temps réel</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#000000">

  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      color: #222;
      transition: background 0.3s, color 0.3s;
    }

    body.night {
      background: #111;
      color: #eee;
    }

    .container {
      max-width: 480px;
      margin: auto;
      padding: 15px;
    }

    button {
      width: 100%;
      padding: 15px;
      margin: 8px 0;
      font-size: 18px;
      border: none;
      border-radius: 8px;
      background: #0078ff;
      color: white;
      cursor: pointer;
    }

    button:active {
      background: #005fcc;
    }

    #status, #distance, #timing {
      font-size: 18px;
      padding: 12px;
      border-radius: 6px;
      margin-top: 10px;
      font-weight: bold;
    }

    #speed {
      font-weight: bold;
      font-size: 48px;
      text-align: center;
      margin-top: 20px;
      color: #222;
    }

    body.night #speed {
      color: #fff;
    }

    .ok {
      background: #d4f8d4;
      color: #0a7a0a;
    }

    body.night .ok {
      background: #003300;
      color: #66ff66;
    }

    .ko {
      background: #ffd6d6;
      color: #a30000;
    }

    body.night .ko {
      background: #330000;
      color: #ff6666;
    }

    .icon {
      text-align: center;
      margin-top: 20px;
    }

    .icon img {
      width: 120px;
      max-width: 60%;
    }
  </style>
</head>
	


<body>

<div class="container">

  <button onclick="startTracking()">Activer la géolocalisation</button>
  <button onclick="stopTracking()">Arrêter la géolocalisation</button>
  <button onclick="toggleNightMode()">Mode nuit</button>

  <div id="status"></div>
  <div id="distance"></div>
  <div id="speed">-- km/h</div>
  <div id="timing">Statut horaire : --</div>
  <div id="icon" class="icon"></div>

  <audio id="alertSound" src="sounds/alert.mp3" preload="auto"></audio>

</div>

<script>
/* ============================
   ZONES GPS
   ============================ */

const zones = [
  {
    type: "circle",
    name: "Route de Vitré",
    lat: 48.29315,
    lng: -0.94432,
    radius: 150,
    expectedTime: "19:14",
    directionIcons: {
      Nord:  "images/f50.png",
      Sud:   "images/50.png",
      Est:   "images/f50.png",
      Ouest: "images/f50.png"
    }
  },

  {
    type: "circle",
    name: "Radar 50",
    lat: 48.29679,
    lng: -0.91787,
    radius: 200,
    directionIcons: {
      Nord:  "images/radar50.png",
      Sud:   "images/radar50.png",
      Est:   "images/radar50.png",
      Ouest: "images/radar50.png"
    }
  },

  {
    type: "circle",
    name: "Radar 80",
    lat: 48.32754,
    lng: -1.10005,
    radius: 200,
    directionIcons: {
      Nord:  "images/radar80.png",
      Sud:   "images/radar80.png",
      Est:   "images/radar80.png",
      Ouest: "images/radar80.png"
    }
  },

  {
    type: "circle",
    name: "Bifurcation",
    lat: 48.22067,
    lng: -1.09273,
    radius: 120,
    expectedTime: "19:30",
    directionIcons: {
      Nord:  "images/droite.png",
      Sud:   "images/gauche.png",
      Est:   "images/gauche.png",
      Ouest: "images/droite.png"
    }
  },

  {
    type: "circle",
    name: "Rond Point Belle Epoque",
    lat: 48.29768,
    lng: -0.93474,
    radius: 100,
    expectedTime: "19:12",
    directionIcons: {
      Nord:  "images/rond.png",
      Sud:   "images/rond.png",
      Est:   "images/rond.png",
      Ouest: "images/rond.png"
    }
  },

  {
    type: "circle",
    name: "Juvigné",
    lat: 48.23222,
    lng: -1.03108,
    radius: 120,
    expectedTime: "19:20",
    directionIcons: {
      Nord:  "images/50.png",
      Sud:   "images/f50.png",
      Est:   "images/50.png",
      Ouest: "images/f50.png"
    }
  },

  {
    type: "circle",
    name: "Princé 1",
    lat: 48.21536,
    lng: -1.08545,
    radius: 120,
    expectedTime: "19:30",
    directionIcons: {
      Nord:  "images/f50.png",
      Sud:   "images/50.png",
      Est:   "images/50.png",
      Ouest: "images/f50.png"
    }
  },

  {
    type: "circle",
    name: "Princé 2",
    lat: 48.21865,
    lng: -1.09058,
    radius: 120,
    expectedTime: "19:30",
    directionIcons: {
      Nord:  "images/50.png",
      Sud:   "images/f50.png",
      Est:   "images/f50.png",
      Ouest: "images/50.png"
    }
  },

  {
    type: "polygon",
    name: "Route",
    points: [
      {lat: 48.29255, lng: -0.94356},
      {lat: 48.29247, lng: -0.94518},
      {lat: 48.23323, lng: -1.02971},
      {lat: 48.23316, lng: -1.02960}
    ],
    directionIcons: {
      Nord:  "images/90.png",
      Sud:   "images/90.png",
      Est:   "images/90.png",
      Ouest: "images/90.png"
    }
  },

  {
    type: "polygon",
    name: "La Croixille",
    points: [
      {lat: 48.20700, lng: -1.05334},
      {lat: 48.20562, lng: -1.05217},
      {lat: 48.20321, lng: -1.05304},
      {lat: 48.20331, lng: -1.06139},
      {lat: 48.20638, lng: -1.06146}
    ],
    directionIcons: {
      Nord:  "images/90.png",
      Sud:   "images/90.png",
      Est:   "images/90.png",
      Ouest: "images/90.png"
    }
  }
];


let watchId = null;
let lastZone = null;
let lastPos = null;
let lastSpeed = 0;

/* ============================
   CALCUL AVANCE / RETARD
   ============================ */

function getTimingStatus(expectedTime) {
  const now = new Date();
  const [h, m] = expectedTime.split(":").map(Number);

  const expected = new Date();
  expected.setHours(h, m, 0, 0);

  const diffMs = now - expected;
  const diffMin = Math.round(diffMs / 60000);

  if (diffMin < 0) return { status: "en avance", minutes: Math.abs(diffMin) };
  if (diffMin > 0) return { status: "en retard", minutes: diffMin };
  return { status: "à l'heure", minutes: 0 };
}

/* ============================
   DISTANCE HAVERSINE
   ============================ */

function distanceMeters(lat1, lon1, lat2, lon2) {
  const R = 6371000;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a =
    Math.sin(dLat/2)**2 +
    Math.cos(lat1*Math.PI/180) *
    Math.cos(lat2*Math.PI/180) *
    Math.sin(dLon/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}

/* ============================
   BEARING (DIRECTION)
   ============================ */

function bearing(lat1, lon1, lat2, lon2) {
  const dLon = (lon2 - lon1) * Math.PI / 180;
  lat1 *= Math.PI / 180;
  lat2 *= Math.PI / 180;

  const y = Math.sin(dLon) * Math.cos(lat2);
  const x = Math.cos(lat1) * Math.sin(lat2) -
            Math.sin(lat1) * Math.cos(lat2) * Math.cos(dLon);

  return (Math.atan2(y, x) * 180 / Math.PI + 360) % 360;
}

function bearingToText(b) {
  if (b >= 45 && b < 135) return "Est";
  if (b >= 135 && b < 225) return "Sud";
  if (b >= 225 && b < 315) return "Ouest";
  return "Nord";
}

/* ============================
   MODE NUIT
   ============================ */

function toggleNightMode() {
  document.body.classList.toggle("night");
}

/* ============================
   TRACKING GPS
   ============================ */

function startTracking() {
  const status = document.getElementById("status");
  const icon = document.getElementById("icon");
  const distanceBox = document.getElementById("distance");
  const speedDisplay = document.getElementById("speed");
  const timingDisplay = document.getElementById("timing");

  if (!navigator.geolocation) {
    status.textContent = "La géolocalisation n'est pas supportée.";
    status.className = "ko";
    return;
  }

  status.textContent = "Géolocalisation en cours...";
  status.className = "";
	


  watchId = navigator.geolocation.watchPosition(
    (pos) => {
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;

      /* --- VITESSE GPS --- */
	 
 
		


function smoothSpeed(s) {
  if (s === null) return lastSpeed;
  lastSpeed = lastSpeed * 0.6 + s * 0.4;
  return lastSpeed;
}

	  
      const speed = pos.coords.speed;
      if (speed === null) {
        speedDisplay.textContent = "-- km/h";
      } else {
        const kmh = (smoothSpeed(speed) * 3.6).toFixed(0);
        speedDisplay.textContent = kmh + " km/h";

        if (kmh < 30) speedDisplay.style.color = "#0a7a0a";
        else if (kmh < 70) speedDisplay.style.color = "#e6a800";
        else speedDisplay.style.color = "#a30000";
      }

      /* --- DÉTECTION ZONES --- */
      let insideZone = null;
      let closestZone = null;
      let minDist = Infinity;

      for (const z of zones) {
        const d = distanceMeters(lat, lng, z.lat, z.lng);

        if (d < minDist) {
          minDist = d;
          closestZone = z;
        }

        if (d <= z.radius) insideZone = z;
      }

      distanceBox.textContent =
        `Distance à la zone la plus proche (${closestZone.name}) : ${Math.round(minDist)} m`;

      /* --- DANS UNE ZONE --- */
      if (insideZone) {

        /* DÉTECTION DU SENS D’ARRIVÉE */
        if (lastZone !== insideZone.name && lastPos) {

          const b = bearing(lastPos.lat, lastPos.lng, lat, lng);
          const dir = bearingToText(b);

          status.textContent = `Arrivée dans ${insideZone.name} depuis le ${dir}`;
          status.className = "ok";

          /* Image spécifique à la zone + direction */
          if (insideZone.directionIcons && insideZone.directionIcons[dir]) {
            icon.innerHTML = `<img src="${insideZone.directionIcons[dir]}" alt="${dir}">`;
          } else {
            icon.innerHTML = `<img src="${insideZone.icon}" alt="${insideZone.name}">`;
          }

        } else {
          status.textContent = `Vous êtes dans ${insideZone.name}`;
          status.className = "ok";
          icon.innerHTML = `<img src="${insideZone.icon}" alt="${insideZone.name}">`;
        }

        /* Avance / retard */
        if (insideZone.expectedTime) {
          const timing = getTimingStatus(insideZone.expectedTime);

          if (timing.status === "en avance") {
            timingDisplay.textContent = `En avance de ${timing.minutes} min`;
            timingDisplay.style.color = "green";
          } else if (timing.status === "en retard") {
            timingDisplay.textContent = `En retard de ${timing.minutes} min`;
            timingDisplay.style.color = "red";
          } else {
            timingDisplay.textContent = "À l'heure";
            timingDisplay.style.color = "orange";
          }
        }

        if (lastZone !== insideZone.name) {
          document.getElementById("alertSound").play();
          lastZone = insideZone.name;
        }

      } else {
        status.textContent = "Vous êtes hors zone";
        status.className = "ko";
        icon.innerHTML = `<img src="images/none.png" alt="Aucun point">`;
        timingDisplay.textContent = "Statut horaire : --";
        timingDisplay.style.color = "white";
        lastZone = null;
      }

      lastPos = { lat, lng };
    },
    (err) => {
      status.textContent = "Erreur : " + err.message;
      status.className = "ko";
    },
    { enableHighAccuracy: true, maximumAge: 1000, timeout: 5000 }
  );
}

/* ============================
   STOP
   ============================ */

function stopTracking() {
  const status = document.getElementById("status");

  if (watchId !== null) {
    navigator.geolocation.clearWatch(watchId);
    watchId = null;
    status.textContent = "Géolocalisation arrêtée.";
    status.className = "ko";
  }
}
	if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("service-worker.js");
}
</script>

</body>
</html>







